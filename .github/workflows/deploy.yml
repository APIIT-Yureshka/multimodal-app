name: Deploy multimodal-app Service

on:
  push:
    branches:
      - main
    tags-ignore:
      - "v*"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. Checkout the repository (needs full history for tags + credentials to push)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2. Generate a unique semver-like tag (vMAJOR.MINOR.PATCH)
      - name: Generate unique tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          latest_tag="$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")"
          IFS='.' read -r major minor patch <<< "${latest_tag#v}"
          patch=$((patch + 1))
          new_tag="v$major.$minor.$patch"

          while git rev-parse "refs/tags/$new_tag" >/dev/null 2>&1; do
            patch=$((patch + 1))
            new_tag="v$major.$minor.$patch"
          done

          echo "NEW_TAG=$new_tag" >> "$GITHUB_ENV"
          echo "New tag: $new_tag"

      # 3. Create and push the tag (needs permissions: contents: write)
      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create tag locally
          git tag "${{ env.NEW_TAG }}"

          # Push only the new tag
          git push origin "${{ env.NEW_TAG }}"

      # 4. Ensure docker network exists (create if missing)
      - name: Ensure Docker network exists
        shell: bash
        run: |
          set -euo pipefail
          sudo docker network inspect multimodal-network >/dev/null 2>&1 || \
          sudo docker network create multimodal-network

      # 5. Build the Docker image
      - name: Build Docker image
        shell: bash
        run: |
          set -euo pipefail
          sudo docker build -t multimodal-app:${{ env.NEW_TAG }} .

      # 6. Stop and remove existing container (if any)
      - name: Stop and remove existing container
        shell: bash
        run: |
          sudo docker stop multimodal-app || true
          sudo docker rm multimodal-app || true

      # 7. Run the updated container
      - name: Run updated container
        shell: bash
        run: |
          set -euo pipefail
          sudo docker run -d \
            --network multimodal-network \
            -p 9876:9876 \
            --restart unless-stopped \
            --name multimodal-app \
            multimodal-app:${{ env.NEW_TAG }}

      # 8. Clean up old Docker images/containers
      - name: Clean up Docker
        shell: bash
        run: |
          sudo docker system prune -af --filter "until=24h"
